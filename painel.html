<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel</title>
  <link rel="stylesheet" href="css/estilo.css">
  <link rel="stylesheet" href="css/responsivo.css">
</head>
<body>
  <nav class="barra-navegacao">
    <div class="container conteudo-barra">
      <a href="painel.html" class="marca">Fortes Engenharia</a>
      <ul class="menu">
        <li><a href="painel.html" class="active">Painel</a></li>
        <li><a href="solicitar.html" data-papel="encarregado">Nova Solicitacao</a></li>
        <li><a href="minhas-solicitacoes.html" data-papel="encarregado">Minhas Solicitacoes</a></li>
        <li><a href="aprovacoes.html" data-papel="gerente">Aprovacoes</a></li>
        <li><a href="relatorios.html">Relatorios</a></li>
        <li><a href="cadastro-projeto.html" data-papel="gerente">Projetos</a></li>
      </ul>
      <div class="info-usuario">
        <a class="user" href="perfil.html"><span class="user-name"></span></a>
        <button class="botao-sair" onclick="Auth.logout()">Sair</button>
      </div>
    </div>
  </nav>

  <div class="container conteudo">
    <div class="cabecalho-pagina">
      <h1>Painel</h1>
      <p>Bem-vindo ao sistema</p>
    </div>

    <div class="grade-estatisticas">
      <div class="cartao cartao-estatistica">
        <div class="rotulo-estatistica">Solicitacoes</div>
        <span class="valor-estatistica" id="stat-total">0</span>
      </div>
      <div class="cartao cartao-estatistica">
        <div class="rotulo-estatistica">Pendentes</div>
        <span class="valor-estatistica" id="stat-pendentes">0</span>
      </div>
      <div class="cartao cartao-estatistica">
        <div class="rotulo-estatistica">Aprovadas</div>
        <span class="valor-estatistica" id="stat-aprovadas">0</span>
      </div>
      <div class="cartao cartao-estatistica">
        <div class="rotulo-estatistica">Horas (Mes)</div>
        <span class="valor-estatistica" id="stat-horas">0h</span>
      </div>
    </div>

    <div class="cartao">
      <h2>Acoes Rapidas</h2>
      <div class="acoes-rapidas">
        <a href="solicitar.html" class="botao" data-papel="encarregado">Nova Solicitacao</a>
        <a href="minhas-solicitacoes.html" class="botao" data-papel="encarregado">Minhas Solicitacoes</a>
        <a href="aprovacoes.html" class="botao" data-papel="gerente">Aprovacoes</a>
        <a href="relatorios.html" class="botao">Relatorios</a>
        <a href="cadastro-projeto.html" class="botao" data-papel="gerente">Projetos</a>
      </div>
    </div>

    <div class="cartao">
      <h2>Solicitacoes Recentes</h2>
      <div id="solicitacoes-recentes"></div>
    </div>
  </div>

  <footer>
    <div class="container">Fortes Engenharia 2025</div>
  </footer>

  <script src="js/autenticacao.js"></script>
  <script src="js/armazenamento.js"></script>
  <script src="js/utilidades.js"></script>

  <script>
    Auth.protegerPagina();

    function carregarPainel() {
      let sessao = Auth.obterSessao();
      let solicitacoes = Storage.obterSolicitacoes();
      
      let minhasSolicitacoes;
      let pendentes;

      if(sessao.papel === 'tecnico') {
        minhasSolicitacoes = solicitacoes;
        pendentes = minhasSolicitacoes.filter(s => s.status === 'pendente');
      } else if(sessao.papel === 'encarregado') {
        minhasSolicitacoes = solicitacoes;
        pendentes = solicitacoes.filter(s => s.status === 'pendente');
      } else {
        minhasSolicitacoes = solicitacoes;
        pendentes = solicitacoes.filter(s => s.status === 'aprovada_encarregado');
      }

      let aprovadas = minhasSolicitacoes.filter(s => 
        s.status === 'aprovada_encarregado' || s.status === 'aprovada_gerente'
      );

      const horasMes = calcularHorasMes(minhasSolicitacoes);

      document.getElementById('stat-total').textContent = minhasSolicitacoes.length;
      document.getElementById('stat-pendentes').textContent = pendentes.length;
      document.getElementById('stat-aprovadas').textContent = aprovadas.length;
      document.getElementById('stat-horas').textContent = horasMes + 'h';

      renderizarSolicitacoesRecentes(minhasSolicitacoes);
    }

    function calcularHorasMes(solicitacoes) {
      const mesAtual = new Date().getMonth();
      const anoAtual = new Date().getFullYear();
      let totalMinutos = 0;

      solicitacoes
        .filter(s => ['aprovada_encarregado', 'aprovada_gerente'].includes(s.status))
        .forEach(sol => {
          if (!sol.itens) return;
          sol.itens.forEach(item => {
            const dataItem = new Date(item.data);
            if (dataItem.getMonth() === mesAtual && dataItem.getFullYear() === anoAtual) {
              totalMinutos += item.minutos || 0;
            }
          });
        });

      return Math.round(totalMinutos / 60);
    }

    function renderizarSolicitacoesRecentes(solicitacoes) {
      const container = document.getElementById('solicitacoes-recentes');
      const recentes = solicitacoes.sort((a, b) => new Date(b.criadoEm) - new Date(a.criadoEm)).slice(0, 5);

      if (recentes.length === 0) {
        container.innerHTML = '<p>Nenhuma solicitacao encontrada.</p>';
        return;
      }

      const colunas = [
        { titulo: 'Data', campo: 'criadoEm', renderizar: (item) => App.formatarData(item.criadoEm) },
        { titulo: 'Projeto', campo: 'projetoNome' },
        { titulo: 'Motivo', campo: 'motivo', renderizar: (item) => item.motivo.length > 50 ? item.motivo.substring(0, 50) + '...' : item.motivo },
        { titulo: 'Status', campo: 'status', renderizar: (item) => `<span class="etiqueta ${App.obterClasseStatus(item.status)}">${App.obterTextoStatus(item.status)}</span>` }
      ];

      App.renderizarTabela('solicitacoes-recentes', recentes, colunas);
    }

    carregarPainel();
  </script>
</body>
</html>
